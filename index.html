<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2Pines Cycle Timer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; transition: background-color 0.5s ease; }
        .editable-lap-time { cursor: pointer; border-bottom: 2px dotted transparent; transition: border-color 0.2s; }
        .editable-lap-time:hover, .editable-lap-time:focus { outline: none; border-bottom: 2px dotted #9ca3af; }
        .editable-lap-time:focus { border-bottom-color: #3b82f6; }
        input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .dropdown-arrow { transition: transform 0.3s ease; }
        .rotate-arrow { transform: rotate(180deg); }
        .process-chip { display: inline-flex; align-items: center; border-radius: 9999px; overflow: hidden; transition: all 0.2s; user-select: none; }
        .process-chip-name { padding: 0.25rem 0.75rem; font-size: 0.875rem; font-weight: 600; cursor: pointer; }
        .process-chip-delete { padding: 0.25rem 0.6rem; font-size: 0.875rem; cursor: pointer; display: flex; align-items: center; justify-content: center; border-left-width: 1px; }
        
        /* Break Mode Animation */
        .break-active {
            background-color: #2563eb !important; /* Blue-600 */
        }
        
        /* Login Screen Overlay */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #111827; z-index: 50;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
    </style>
</head>

<body class="bg-gray-900 text-white min-h-screen p-4">

    <!-- Login/ID Screen -->
    <div id="loginOverlay">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl max-w-md w-full text-center">
            <h1 class="text-3xl font-bold mb-6 text-white">2Pines Timer</h1>
            <p class="text-gray-400 mb-6">Enter a Project ID to connect.</p>
            
            <input type="text" id="projectIdInput" placeholder="Enter Project ID (e.g. 'Line-1')" 
                   class="w-full p-3 bg-gray-700 text-white rounded-lg text-center focus:outline-none focus:ring-2 focus:ring-blue-500 mb-6 text-lg">
            
            <button id="connectBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full transition-all transform hover:scale-105 active:scale-95 shadow-lg">
                Connect
            </button>
            <p id="loginError" class="text-red-400 mt-4 text-sm hidden font-bold"></p>
        </div>
    </div>

    <!-- Main App UI (Hidden by default) -->
    <div id="appContainer" class="container text-center w-full hidden relative">
        
        <!-- HEADER ROW -->
        <div class="flex justify-between items-center mb-4 relative">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-300">2Pines Cycle Timer</h1>
            
            <div class="flex items-center space-x-2">
                <div class="text-xs text-gray-500 bg-gray-800 px-2 py-1 rounded" id="currentProjectIdDisplay">ID: --</div>
                <!-- SETTINGS BUTTON -->
                <button id="settingsBtn" class="p-2 bg-gray-800 rounded-full hover:bg-gray-700 transition-colors text-gray-300">
                    ⚙️
                </button>
            </div>
        </div>

        <!-- BREAK MESSAGE OVERLAY (Only visible during break) -->
        <div id="breakMessage" class="hidden fixed inset-0 flex items-center justify-center pointer-events-none z-40">
            <div class="text-white text-6xl font-bold opacity-20">BREAK TIME</div>
        </div>

        <!-- JOB TITLE INPUT -->
        <div class="mb-6 px-4">
            <input type="text" id="globalJobTitleInput" placeholder="Enter Job Title (e.g. PO# 1234 - Cabinet Assembly)" 
                   class="w-full text-center bg-gray-800 text-white text-xl md:text-2xl font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 border border-gray-700 placeholder-gray-500 transition-all">
        </div>

        <div class="mb-4 p-3 bg-gray-800 rounded-lg shadow-inner">
            <div class="flex flex-wrap items-center justify-center space-x-4 mb-3">
                <h3 class="text-xl font-bold">Processes</h3>
                <button id="newProcessBtn" class="bg-blue-600 text-white px-3 py-1 rounded-full font-semibold text-sm transition-transform transform hover:scale-105 active:scale-95 shadow-lg">+ New Process</button>
            </div>
            <div id="processToggles" class="flex flex-wrap justify-center gap-2 max-h-24 overflow-y-auto p-1"></div>
        </div>
        
        <input type="text" id="secondaryTitleInput" placeholder="Process Name (e.g., 'Edge Sander')" class="w-full text-center bg-transparent text-gray-400 text-base sm:text-lg md:text-xl font-light mb-8 focus:outline-none focus:border-b-2 focus:border-gray-500">

        <div class="mb-8">
            <div class="text-sm font-semibold text-gray-400">Total</div>
            <div id="mainTimeDisplay" class="text-2xl md:text-3xl font-bold tracking-tight">00:00:00</div>
            <div class="text-sm font-semibold text-gray-400 mt-4">Lap</div>
            <div id="currentLapDisplay" class="text-5xl md:text-7xl text-gray-500 mt-2">00:00:00</div>
        </div>

        <div class="mb-8 p-3 bg-gray-800 rounded-lg shadow-inner">
            <h3 class="text-lg font-bold mb-2">Target Range</h3>
            <div class="flex flex-wrap justify-center items-center space-x-2">
                <div class="flex items-center space-x-1">
                    <span class="text-gray-400 text-sm">Min:</span>
                    <input type="number" id="minHoursInput" placeholder="H" min="0" max="99" class="w-12 p-1 bg-gray-700 text-white rounded-md text-center">
                    <span class="text-gray-400 text-sm">:</span>
                    <input type="number" id="minMinutesInput" placeholder="M" min="0" max="59" class="w-12 p-1 bg-gray-700 text-white rounded-md text-center">
                    <span class="text-gray-400 text-sm">:</span>
                    <input type="number" id="minSecondsInput" placeholder="S" min="0" max="59" class="w-12 p-1 bg-gray-700 text-white rounded-md text-center">
                </div>
                <div class="flex items-center space-x-1 mt-2 sm:mt-0">
                    <span class="text-gray-400 text-sm">Max:</span>
                    <input type="number" id="maxHoursInput" placeholder="H" min="0" max="99" class="w-12 p-1 bg-gray-700 text-white rounded-md text-center">
                    <span class="text-gray-400 text-sm">:</span>
                    <input type="number" id="maxMinutesInput" placeholder="M" min="0" max="59" class="w-12 p-1 bg-gray-700 text-white rounded-md text-center">
                    <span class="text-gray-400 text-sm">:</span>
                    <input type="number" id="maxSecondsInput" placeholder="S" min="0" max="59" class="w-12 p-1 bg-gray-700 text-white rounded-md text-center">
                </div>
            </div>
            <div id="rangeStatus" class="h-8 w-32 mt-2 mx-auto rounded-md"></div>
        </div>

        <div class="flex flex-wrap justify-center space-x-2 sm:space-x-4 mb-8">
            <button id="resetBtn" class="bg-red-600 text-white px-4 py-2 rounded-full font-semibold text-lg transition-transform transform hover:scale-105 active:scale-95 shadow-lg mb-2 sm:mb-0">Reset</button>
            <button id="pauseBtn" class="bg-yellow-500 text-white px-6 py-3 rounded-full font-semibold text-lg transition-transform transform hover:scale-105 active:scale-95 shadow-lg mb-2 sm:mb-0 hidden">Pause</button>
            <button id="lapBtn" class="bg-green-600 text-white px-8 py-4 rounded-full font-semibold text-lg transition-transform transform hover:scale-105 active:scale-95 shadow-lg mb-2 sm:mb-0">Lap</button>
            <button id="startBtn" class="bg-blue-600 text-white px-6 py-3 rounded-full font-semibold text-lg transition-transform transform hover:scale-105 active:scale-95 shadow-lg">Start</button>
        </div>

        <div class="p-3 bg-gray-800 rounded-lg shadow-inner mb-8">
            <button id="toggleNotesBtn" class="w-full flex justify-between items-center text-lg font-bold"><span>Notes</span><span id="notesArrow" class="dropdown-arrow">&#9660;</span></button>
            <div id="notesContainer" class="mt-4 hidden">
                <textarea id="notesInput" placeholder="Add notes for this session..." class="w-full h-32 p-2 bg-gray-700 text-white rounded-md resize-none focus:outline-none focus:border-2 focus:border-gray-500"></textarea>
            </div>
        </div>

        <div id="statsContainer" class="w-full max-w-sm mx-auto mb-8">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-lg font-bold">Statistics</h3>
                <button id="printBtn" class="bg-gray-700 text-white px-3 py-1 rounded-full font-semibold text-sm transition-transform transform hover:scale-105 active:scale-95 shadow-lg">Print Preview</button>
            </div>
            <p id="totalLaps" class="text-gray-300">Total Pieces: 0</p>
            <p id="averageTime" class="text-gray-300">Average Time: 00:00:00</p>
            <p id="sessionIdDisplay" class="text-xs text-gray-500 mt-2 break-all"></p>
        </div>

        <div class="text-left w-full max-w-sm mx-auto overflow-y-auto max-h-96 pr-4">
            <h3 class="text-lg font-bold mb-2">#Pieces</h3>
            <ul id="lapList"></ul>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal" class="fixed inset-0 bg-gray-900 bg-opacity-95 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-sm border border-gray-700">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white">Settings</h2>
                <button id="closeSettingsBtn" class="text-gray-400 hover:text-white font-bold text-xl">&times;</button>
            </div>
            
            <div class="mb-6">
                <h3 class="text-md font-bold text-gray-300 mb-2">Scheduled Breaks</h3>
                <p class="text-xs text-gray-500 mb-3">Add break times. When the clock hits this time, the screen will turn blue for 5 minutes.</p>
                
                <div class="flex space-x-2 mb-3">
                    <input type="time" id="breakTimeInput" class="flex-1 bg-gray-700 text-white p-2 rounded border border-gray-600 focus:outline-none focus:border-blue-500">
                    <button id="addBreakBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded font-bold">Add</button>
                </div>

                <ul id="breaksList" class="bg-gray-900 rounded p-2 max-h-40 overflow-y-auto border border-gray-700">
                    <!-- Breaks will be injected here -->
                    <li class="text-gray-500 text-sm text-center py-2">No breaks set</li>
                </ul>
            </div>
        </div>
    </div>

    <div id="confirmationModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl text-center">
            <p id="modalMessage" class="text-white text-lg mb-4">Are you sure you want to do this?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirmYesBtn" class="bg-red-600 text-white px-4 py-2 rounded-full font-semibold">Yes</button>
                <button id="confirmCancelBtn" class="bg-gray-600 text-white px-4 py-2 rounded-full font-semibold">Cancel</button>
            </div>
        </div>
    </div>
    
    <div id="newProcessModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl text-center">
            <p class="text-white text-lg mb-4">Enter a name for the new process:</p>
            <input type="text" id="newProcessNameInput" placeholder="Process Name" class="w-full p-2 bg-gray-700 text-white rounded-md text-center focus:outline-none mb-4">
            <div class="flex justify-center space-x-4">
                <button id="createProcessBtn" class="bg-green-600 text-white px-4 py-2 rounded-full font-semibold">Create</button>
                <button id="cancelProcessBtn" class="bg-gray-600 text-white px-4 py-2 rounded-full font-semibold">Cancel</button>
            </div>
        </div>
    </div>

    <!-- FIREBASE AND APP LOGIC -->
    <script type="module">
        // ==========================================
        //  FIREBASE CONFIGURATION
        // ==========================================
        const YOUR_FIREBASE_CONFIG = {
            apiKey: "AIzaSyCuwPLshLE4UtE5CQ8dCXkAr_wVtVEjJ9I",
            authDomain: "pinescycletimer.firebaseapp.com",
            projectId: "pinescycletimer",
            storageBucket: "pinescycletimer.firebasestorage.app",
            messagingSenderId: "283495848296",
            appId: "1:283495848296:web:9597807f344dad11e89edd",
            measurementId: "G-CWE7R1M0EX"
        };
        // ==========================================
        
        // Importing standard, stable versions (v10.13.0)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, collection } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

        // --- GLOBAL STATE ---
        let processes = [];
        let breaks = []; // Array of string "HH:MM" (24h)
        let activeProcessId = null;
        let timer;
        let breakCheckInterval;
        let isRunning = false;
        let currentProjectId = null;
        let db = null;
        let auth = null;
        let jobTitle = ""; 
        
        const loginOverlay = document.getElementById('loginOverlay');
        const projectIdInput = document.getElementById('projectIdInput');
        const connectBtn = document.getElementById('connectBtn');
        const appContainer = document.getElementById('appContainer');
        const currentProjectIdDisplay = document.getElementById('currentProjectIdDisplay');
        const loginError = document.getElementById('loginError');

        const globalJobTitleInput = document.getElementById('globalJobTitleInput'); 
        const mainTimeDisplay = document.getElementById('mainTimeDisplay');
        const currentLapDisplay = document.getElementById('currentLapDisplay');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const lapBtn = document.getElementById('lapBtn');
        const resetBtn = document.getElementById('resetBtn');
        const printBtn = document.getElementById('printBtn');
        const totalLapsElement = document.getElementById('totalLaps');
        const averageTimeElement = document.getElementById('averageTime');
        const lapList = document.getElementById('lapList');
        const minHoursInput = document.getElementById('minHoursInput');
        const minMinutesInput = document.getElementById('minMinutesInput');
        const minSecondsInput = document.getElementById('minSecondsInput');
        const maxHoursInput = document.getElementById('maxHoursInput');
        const maxMinutesInput = document.getElementById('maxMinutesInput');
        const maxSecondsInput = document.getElementById('maxSecondsInput');
        const rangeStatus = document.getElementById('rangeStatus');
        const sessionIdDisplay = document.getElementById('sessionIdDisplay');
        
        // Notes dropdown elements
        const notesInput = document.getElementById('notesInput');
        const toggleNotesBtn = document.getElementById('toggleNotesBtn');
        const notesContainer = document.getElementById('notesContainer');
        const notesArrow = document.getElementById('notesArrow');
        
        // Modals
        const confirmationModal = document.getElementById('confirmationModal');
        const modalMessage = document.getElementById('modalMessage');
        const confirmYesBtn = document.getElementById('confirmYesBtn');
        const confirmCancelBtn = document.getElementById('confirmCancelBtn');
        const newProcessModal = document.getElementById('newProcessModal');
        const newProcessNameInput = document.getElementById('newProcessNameInput');
        const createProcessBtn = document.getElementById('createProcessBtn');
        const cancelProcessBtn = document.getElementById('cancelProcessBtn');
        const processToggles = document.getElementById('processToggles');

        // Settings Modal Elements
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsBtn = document.getElementById('closeSettingsBtn');
        const breakTimeInput = document.getElementById('breakTimeInput');
        const addBreakBtn = document.getElementById('addBreakBtn');
        const breaksList = document.getElementById('breaksList');
        const breakMessage = document.getElementById('breakMessage');

        // --- Firebase Init ---
        async function initFirebase() {
            try {
                const app = initializeApp(YOUR_FIREBASE_CONFIG);
                auth = getAuth(app);
                db = getFirestore(app);
                await signInAnonymously(auth);
                console.log("Firebase signed in (Anonymous)");
                return true;
            } catch (error) {
                console.error("Initialization error:", error);
                const msg = "CONNECTION ERROR:\n" + error.message + "\n\nTip: Did you enable 'Anonymous' in Firebase Authentication?";
                alert(msg); 
                loginError.textContent = "Error: " + error.message;
                loginError.classList.remove('hidden');
                return false;
            }
        }

        // --- Connection Logic ---
        async function handleConnect() {
            let projectId = projectIdInput.value.trim();
            projectId = projectId.replace(/\//g, '-');
            
            if (!projectId) {
                loginError.textContent = "Please enter a valid Project ID";
                loginError.classList.remove('hidden');
                return;
            }

            connectBtn.disabled = true;
            connectBtn.textContent = "Connecting...";
            loginError.classList.add('hidden');

            try {
                if (!db) {
                    const success = await initFirebase();
                    if (!success) throw new Error("Initialization failed");
                }

                currentProjectId = projectId;
                currentProjectIdDisplay.textContent = `ID: ${projectId}`;
                
                setupRealtimeListener(projectId);
                startBreakCheck(); // Start the break clock
                
                loginOverlay.style.display = 'none';
                appContainer.classList.remove('hidden');

            } catch (e) {
                console.error("Connect error:", e);
                connectBtn.disabled = false;
                connectBtn.textContent = "Connect";
            }
        }

        connectBtn.addEventListener('click', handleConnect);
        projectIdInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') { e.preventDefault(); handleConnect(); }
        });

        function setupRealtimeListener(projectId) {
            const appId = '2pines-timer-app'; 
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'cycle_timer_sessions', projectId);

            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.processes) processes = data.processes;
                    
                    if (data.jobTitle !== undefined) {
                        jobTitle = data.jobTitle;
                        if (document.activeElement !== globalJobTitleInput) {
                            globalJobTitleInput.value = jobTitle;
                        }
                    }

                    // Sync Breaks
                    if (data.breaks) {
                        breaks = data.breaks;
                        renderBreaksList(); // Update modal list
                        checkBreaks(); // Check immediately
                    }

                    if (!activeProcessId && processes.length > 0) {
                        activeProcessId = processes[0].id;
                    }
                    else if (activeProcessId && !getActiveProcess() && processes.length > 0) {
                         activeProcessId = processes[0].id;
                    }

                    displayProcessToggles();
                    updateAllViews();
                } else {
                    console.log("New project created");
                    processes = [];
                    breaks = [];
                    jobTitle = "";
                    createNewProcess("Process 1");
                }
            }, (error) => {
                console.error("Sync error:", error);
                if (error.code === 'permission-denied') {
                    alert("DATABASE ERROR: Permission Denied.\n\nPlease go to Firebase Console -> Firestore Database -> Rules and ensure they are set to allow read/write (Test Mode).");
                }
            });
        }

        // --- BREAK LOGIC ---
        function startBreakCheck() {
            if (breakCheckInterval) clearInterval(breakCheckInterval);
            breakCheckInterval = setInterval(checkBreaks, 1000); // Check every second
        }

        function checkBreaks() {
            const now = new Date();
            const currentHours = now.getHours();
            const currentMinutes = now.getMinutes();
            const currentTotalMinutes = (currentHours * 60) + currentMinutes;

            let isBreakTime = false;

            if (breaks && breaks.length > 0) {
                for (let b of breaks) {
                    // b is "HH:MM"
                    const [h, m] = b.split(':').map(Number);
                    const breakStartTotalMinutes = (h * 60) + m;
                    
                    // Break lasts 5 minutes
                    if (currentTotalMinutes >= breakStartTotalMinutes && currentTotalMinutes < breakStartTotalMinutes + 5) {
                        isBreakTime = true;
                        break;
                    }
                }
            }

            if (isBreakTime) {
                document.body.classList.add('break-active');
                breakMessage.classList.remove('hidden');
            } else {
                document.body.classList.remove('break-active');
                breakMessage.classList.add('hidden');
            }
        }

        // --- BREAK UI HANDLERS ---
        settingsBtn.addEventListener('click', () => {
            renderBreaksList();
            settingsModal.classList.remove('hidden');
        });
        closeSettingsBtn.addEventListener('click', () => {
            settingsModal.classList.add('hidden');
        });

        addBreakBtn.addEventListener('click', () => {
            const val = breakTimeInput.value;
            if (!val) return;
            
            // Check for duplicate
            if (!breaks.includes(val)) {
                breaks.push(val);
                breaks.sort(); // Keep sorted by time
                saveState(); // Save to DB
                renderBreaksList();
                checkBreaks(); // Check immediately
            }
            breakTimeInput.value = '';
        });

        function deleteBreak(timeStr) {
            breaks = breaks.filter(b => b !== timeStr);
            saveState();
            renderBreaksList();
            checkBreaks();
        }

        function renderBreaksList() {
            breaksList.innerHTML = '';
            if (!breaks || breaks.length === 0) {
                breaksList.innerHTML = '<li class="text-gray-500 text-sm text-center py-2">No breaks set</li>';
                return;
            }

            breaks.forEach(b => {
                // Convert 24h to 12h for display
                const [h, m] = b.split(':');
                const hour = parseInt(h);
                const ampm = hour >= 12 ? 'PM' : 'AM';
                const hour12 = hour % 12 || 12;
                const displayTime = `${hour12}:${m} ${ampm}`;

                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-gray-800 p-2 mb-1 rounded text-white';
                li.innerHTML = `
                    <span>${displayTime}</span>
                    <button class="text-red-400 hover:text-red-300 font-bold px-2">&times;</button>
                `;
                li.querySelector('button').onclick = () => deleteBreak(b);
                breaksList.appendChild(li);
            });
        }
        
        function formatTime(milliseconds) {
            const totalSeconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        function parseTime(timeString) {
            const parts = timeString.split(':');
            let hours = 0, minutes = 0, seconds = 0;
            if (parts.length === 3) { hours = parseInt(parts[0], 10); minutes = parseInt(parts[1], 10); seconds = parseInt(parts[2], 10); } 
            else if (parts.length === 2) { minutes = parseInt(parts[0], 10); seconds = parseInt(parts[1], 10); } 
            else return null;
            if (isNaN(hours) || isNaN(minutes) || isNaN(seconds)) return null;
            return (hours * 3600000) + (minutes * 60000) + (seconds * 1000);
        }
        function formatRange(range) {
            if (!range) return 'N/A';
            return `${range.h || '0'}:${range.m || '0'}:${range.s || '0'}`;
        }
        function getRangeMs(hoursInput, minutesInput, secondsInput) {
            const hours = parseInt(hoursInput.value, 10) || 0;
            const minutes = parseInt(minutesInput.value, 10) || 0;
            const seconds = parseInt(secondsInput.value, 10) || 0;
            return (hours * 3600000) + (minutes * 60000) + (seconds * 1000);
        }
        function getActiveProcess() { return processes.find(p => p.id === activeProcessId); }

        function updateAllViews(force = false) {
            const activeProcess = getActiveProcess();
            if (!activeProcess) { mainTimeDisplay.textContent = '00:00:00'; currentLapDisplay.textContent = '00:00:00'; return; }
            
            // force flag ignores "activeElement" check to allow overwriting when switching tabs
            if (force || document.activeElement !== minHoursInput) minHoursInput.value = activeProcess.minRange.h || '';
            if (force || document.activeElement !== minMinutesInput) minMinutesInput.value = activeProcess.minRange.m || '';
            if (force || document.activeElement !== minSecondsInput) minSecondsInput.value = activeProcess.minRange.s || '';
            if (force || document.activeElement !== maxHoursInput) maxHoursInput.value = activeProcess.maxRange.h || '';
            if (force || document.activeElement !== maxMinutesInput) maxMinutesInput.value = activeProcess.maxRange.m || '';
            if (force || document.activeElement !== maxSecondsInput) maxSecondsInput.value = activeProcess.maxRange.s || '';
            if (force || document.activeElement !== secondaryTitleInput) secondaryTitleInput.value = activeProcess.secondaryTitle || '';
            if (force || document.activeElement !== notesInput) notesInput.value = activeProcess.notes || '';
            
            // --- FIX: Update Time Displays Immediately ---
            let currentLapTime = 0;
            if (activeProcess.isRunning) {
                currentLapTime = (Date.now() - activeProcess.lapStartTime) + activeProcess.pausedLapTime;
            } else {
                currentLapTime = activeProcess.pausedLapTime;
            }
            mainTimeDisplay.textContent = formatTime(activeProcess.elapsedTime + currentLapTime);
            currentLapDisplay.textContent = formatTime(currentLapTime);
            // ---------------------------------------------

            updateStats(); 
            checkLapRange(activeProcess.averageTime); 
            displayLaps(activeProcess.laps, lapList);
            sessionIdDisplay.textContent = `Process ID: ${activeProcess.id}`;
             
            if (activeProcess.isRunning) { startBtn.classList.add('hidden'); pauseBtn.classList.remove('hidden'); } 
            else { startBtn.classList.remove('hidden'); pauseBtn.classList.add('hidden'); }

            if (activeProcess.isRunning && !isRunning) startTimerLoop();
            else if (!activeProcess.isRunning && isRunning) stopTimerLoop();
        }

        function createNewProcess(name = 'Process 1') {
            // Force blur to save current state of OLD process before creating new
            if (document.activeElement instanceof HTMLElement) document.activeElement.blur();

            const newId = `process_${Math.random().toString(36).substr(2, 9)}`;
            const newProcess = {
                id: newId, name: name, laps: [],
                minRange: { h: '', m: '', s: '' }, maxRange: { h: '', m: '', s: '' },
                elapsedTime: 0, pausedLapTime: 0, lapStartTime: 0, isRunning: false,
                lastUpdated: Date.now(), totalTime: 0, averageTime: 0, 
                secondaryTitle: '', 
                notes: ''
            };
            processes.push(newProcess); 
            activeProcessId = newId; 
            
            updateAllViews(true); // Force update to clear inputs
            displayProcessToggles(); 
            saveState(); 
        }

        function switchProcess(id) {
            // 1. Force blur on any active input to trigger its 'change' event and save data for the OLD process
            if (document.activeElement instanceof HTMLElement) {
                document.activeElement.blur();
            }

            // 2. Switch context
            activeProcessId = id;
            if (!getActiveProcess() && processes.length > 0) activeProcessId = processes[0].id;
            
            // 3. Force update views (true = ignore activeElement check)
            updateAllViews(true);
            displayProcessToggles(); 
        }

        function deleteProcess(id) {
            const index = processes.findIndex(p => p.id === id);
            if (index === -1 || processes.length <= 1) return;
            processes.splice(index, 1);
            if (activeProcessId === id) activeProcessId = processes[0].id;
            saveState(); displayProcessToggles(); updateAllViews(true);
        }

        function displayProcessToggles() {
            processToggles.innerHTML = '';
            processes.forEach(process => {
                const isActive = process.id === activeProcessId;
                const chip = document.createElement('div');
                chip.className = `process-chip m-1 border ${isActive ? 'bg-green-600 border-green-500 text-white' : 'bg-gray-700 border-gray-600 text-gray-300 hover:border-gray-500'}`;
                const nameSpan = document.createElement('span');
                nameSpan.className = 'process-chip-name'; nameSpan.textContent = process.name;
                nameSpan.onclick = () => switchProcess(process.id);
                chip.appendChild(nameSpan);
                if (processes.length > 1) {
                    const deleteBtn = document.createElement('span');
                    deleteBtn.className = `process-chip-delete ${isActive ? 'border-green-500 hover:bg-green-700 text-green-100' : 'border-gray-600 hover:bg-gray-600 text-gray-500 hover:text-red-400'}`;
                    deleteBtn.innerHTML = '&times;';
                    deleteBtn.onclick = (e) => { e.stopPropagation(); showConfirmationModal(`Delete "${process.name}"?`, () => deleteProcess(process.id)); };
                    chip.appendChild(deleteBtn);
                }
                processToggles.appendChild(chip);
            });
        }

        function saveState() {
            if (!currentProjectId || !db) return;
            
            const activeProcess = getActiveProcess();
            if (activeProcess) {
                // Only read DOM values if we are confident they belong to this process
                // But generally safe to read if we just switched?
                // Actually, wait. We read values here.
                activeProcess.minRange = { h: minHoursInput.value, m: minMinutesInput.value, s: minSecondsInput.value };
                activeProcess.maxRange = { h: maxHoursInput.value, m: maxMinutesInput.value, s: maxSecondsInput.value };
                activeProcess.secondaryTitle = secondaryTitleInput.value;
                activeProcess.notes = notesInput.value;
                activeProcess.lastUpdated = Date.now();
                activeProcess.totalTime = activeProcess.elapsedTime + activeProcess.pausedLapTime;
                activeProcess.averageTime = activeProcess.laps.length > 0 ? activeProcess.elapsedTime / activeProcess.laps.length : 0;
            }
            const appId = '2pines-timer-app';
            setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'cycle_timer_sessions', currentProjectId), {
                processes: processes,
                jobTitle: globalJobTitleInput.value,
                breaks: breaks
            }, { merge: true }).catch(err => console.error("Save failed", err));
        }

        function updateTimers() {
            const activeProcess = getActiveProcess();
            if (!activeProcess || !activeProcess.isRunning) return;
            const currentTime = Date.now();
            const currentLapTime = (currentTime - activeProcess.lapStartTime) + activeProcess.pausedLapTime;
            mainTimeDisplay.textContent = formatTime(activeProcess.elapsedTime + currentLapTime);
            currentLapDisplay.textContent = formatTime(currentLapTime);
        }
        function startTimerLoop() { if (!isRunning) { isRunning = true; timer = setInterval(updateTimers, 10); } }
        function stopTimerLoop() { if (isRunning) { clearInterval(timer); isRunning = false; } }
        function startTimerLogic(process) { if (process.isRunning) return; process.isRunning = true; process.lapStartTime = Date.now(); saveState(); }
        function pauseTimerLogic(process) { if (!process.isRunning) return; process.isRunning = false; process.pausedLapTime += Date.now() - process.lapStartTime; saveState(); }
        function onStartClick() { const p = getActiveProcess(); if (p) startTimerLogic(p); }
        function onPauseClick() { const p = getActiveProcess(); if (p) pauseTimerLogic(p); }
        function recordLap() {
            const activeProcess = getActiveProcess();
            if (!activeProcess || !activeProcess.isRunning) return;
            const lapTime = (Date.now() - activeProcess.lapStartTime) + activeProcess.pausedLapTime;
            activeProcess.laps.unshift({ time: lapTime, isEdited: false });
            activeProcess.elapsedTime = activeProcess.laps.reduce((sum, lap) => sum + lap.time, 0);
            activeProcess.lapStartTime = Date.now();
            activeProcess.pausedLapTime = 0;
            saveState();
        }
        function resetTimer() {
            const activeProcess = getActiveProcess(); if (!activeProcess) return;
            activeProcess.isRunning = false; activeProcess.elapsedTime = 0; activeProcess.pausedLapTime = 0;
            activeProcess.laps = []; activeProcess.averageTime = 0;
            updateAllViews(true); // Force update to clear laps
            saveState();
        }
        function displayLaps(lapsArray, listElement) {
            listElement.innerHTML = '';
            lapsArray.forEach((lap, index) => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center py-1 border-b border-gray-700 last:border-b-0';
                const highlightClass = lap.isEdited ? 'text-yellow-400' : (lap.time < 5000 ? 'text-red-400 font-bold' : '');
                li.innerHTML = `<span class="text-sm text-gray-300">#${lapsArray.length - index}</span><span class="flex items-center space-x-1"><span class="font-mono text-lg ${highlightClass} editable-lap-time" contenteditable="true" data-index="${index}">${formatTime(lap.time)}</span><button class="remove-lap-btn text-red-500 hover:text-red-400 text-sm font-bold pl-2" data-index="${index}">&times;</button></span>`;
                listElement.appendChild(li);
            });
        }
        function updateStats() {
            const activeProcess = getActiveProcess(); if (!activeProcess) return;
            totalLapsElement.textContent = `Total Pieces: ${activeProcess.laps.length}`;
            if (activeProcess.laps.length > 0) {
                const totalMilliseconds = activeProcess.elapsedTime;
                activeProcess.averageTime = totalMilliseconds / activeProcess.laps.length;
                averageTimeElement.textContent = `Average Time: ${formatTime(activeProcess.averageTime)}`;
            } else { activeProcess.averageTime = 0; averageTimeElement.textContent = 'Average Time: 00:00:00'; }
        }
        function checkLapRange(averageMs) {
            const minMs = getRangeMs(minHoursInput, minMinutesInput, minSecondsInput);
            const maxMs = getRangeMs(maxHoursInput, maxMinutesInput, maxSecondsInput);
            rangeStatus.className = 'h-8 w-32 mt-2 mx-auto rounded-md';
            const activeProcess = getActiveProcess();
            if (!activeProcess || activeProcess.laps.length === 0 || isNaN(minMs) || isNaN(maxMs) || minMs >= maxMs) return;
            if (averageMs < minMs) rangeStatus.classList.add('bg-green-400');
            else if (averageMs >= minMs && averageMs <= maxMs) rangeStatus.classList.add('bg-yellow-400');
            else rangeStatus.classList.add('bg-red-400');
        }
        async function printData() {
            if (!processes || processes.length === 0) return;

            let allContentHtml = '';

            processes.forEach(proc => {
                const secondaryTitle = proc.secondaryTitle || 'N/A';
                const notes = proc.notes || '';
                const myTotalLaps = proc.laps.length;
                const myTotalTime = formatTime(proc.elapsedTime + proc.pausedLapTime);
                const myAverageTime = formatTime(proc.averageTime);
                const myMinRange = formatRange(proc.minRange);
                const myMaxRange = formatRange(proc.maxRange);
                
                const myRangeDisplay = (proc.minRange.h || proc.minRange.m || proc.minRange.s || proc.maxRange.h || proc.maxRange.m || proc.maxRange.s) ? 
                    `<li class="stats-item"><span>Range:</span><span>${myMinRange} - ${myMaxRange}</span></li>` : '';
                
                const notesDisplay = notes ? 
                    `<div class="notes-section"><span style="font-weight: bold;">Notes:</span> ${notes.replace(/\n/g, '<br>')}</div>` : '';

                allContentHtml += `
                    <div class="process-container">
                        <h2>${proc.name}</h2>
                        <p class="print-secondary-title">${secondaryTitle}</p>
                        <ul class="stats-list">
                            <li class="stats-item"><span>Total Time:</span><span>${myTotalTime}</span></li>
                            <li class="stats-item"><span>Total Pieces:</span><span>${myTotalLaps}</span></li>
                            <li class="stats-item"><span>Average Time:</span><span>${myAverageTime}</span></li>
                            ${myRangeDisplay}
                        </ul>
                        ${notesDisplay}
                    </div>
                `;
            });

            const printWindow = window.open('', '_blank');
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>2Pines Cycle Timer - Print Preview</title>
                    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
                    <style>
                        body { font-family: 'Inter', sans-serif; padding: 20px; color: #1f2937; font-size: 16px; }
                        h1 { text-align: center; font-weight: bold; margin-bottom: 1em; font-size: 24px; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; }
                        .process-container { border: 1px solid #000; padding: 20px; margin-bottom: 20px; page-break-inside: avoid; border-radius: 8px; }
                        h2 { text-align: center; font-weight: bold; margin-top: 0; margin-bottom: 0.2em; font-size: 20px; }
                        .print-secondary-title { text-align: center; font-style: italic; color: #4b5563; margin-bottom: 1em; }
                        .stats-list { list-style-type: none; padding: 0; max-width: 400px; margin: 0 auto; }
                        .stats-item { display: flex; justify-content: space-between; border-bottom: 1px solid #e5e7eb; padding: 8px 0; }
                        .stats-item:last-child { border-bottom: none; }
                        .notes-section { margin-top: 15px; padding: 10px; background-color: #f9fafb; border-radius: 4px; border: 1px dashed #d1d5db; }
                    </style>
                </head>
                <body>
                    <h1>Job: ${globalJobTitleInput.value || 'Untitled Job'}</h1>
                    ${allContentHtml}
                </body>
                </html>
            `;
            printWindow.document.open();
            printWindow.document.write(printContent);
            printWindow.document.close();
        }
        function showConfirmationModal(message, onConfirm) {
            modalMessage.textContent = message; confirmationModal.classList.remove('hidden');
            const handleYes = () => { onConfirm(); hideConfirmationModal(); cleanup(); };
            const handleCancel = () => { hideConfirmationModal(); cleanup(); };
            const cleanup = () => { confirmYesBtn.removeEventListener('click', handleYes); confirmCancelBtn.removeEventListener('click', handleCancel); };
            confirmYesBtn.addEventListener('click', handleYes); confirmCancelBtn.addEventListener('click', handleCancel);
        }
        function hideConfirmationModal() { confirmationModal.classList.add('hidden'); }
        function showNewProcessModal() { newProcessNameInput.value = ''; newProcessModal.classList.remove('hidden'); newProcessNameInput.focus(); }
        function hideNewProcessModal() { newProcessModal.classList.add('hidden'); }
        
        document.addEventListener('keydown', (event) => {
            if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') return;
            const p = getActiveProcess(); if (!p) return;
            if (event.key === ' ' && p.isRunning) { event.preventDefault(); recordLap(); } 
            else if (event.key === 'Enter') { event.preventDefault(); if (p.isRunning) onPauseClick(); else onStartClick(); } 
            else if (event.key === 'r' || event.key === 'R') { event.preventDefault(); showConfirmationModal(`Reset "${p.name}"?`, resetTimer); }
        });
        toggleNotesBtn.addEventListener('click', () => { notesContainer.classList.toggle('hidden'); notesArrow.classList.toggle('rotate-arrow'); });
        
        // FIXED LAP CLICK HANDLER
        lapList.addEventListener('click', (event) => {
            // Use closest to find the button even if clicking the X icon/text
            const btn = event.target.closest('.remove-lap-btn');
            if (btn) {
                const p = getActiveProcess(); 
                if (!p) return; 
                const index = btn.getAttribute('data-index'); 
                p.laps.splice(index, 1); 
                updateAllViews(); // Update UI immediately
                saveState(); // Save to DB
            }
        });

        lapList.addEventListener('blur', (event) => {
            if (event.target.classList.contains('editable-lap-time')) {
                const p = getActiveProcess(); if (!p) return;
                const index = event.target.getAttribute('data-index');
                const newTimeMs = parseTime(event.target.textContent);
                if (newTimeMs !== null && p.laps[index].time !== newTimeMs) { p.laps[index].time = newTimeMs; p.laps[index].isEdited = true; saveState(); } 
                else { event.target.textContent = formatTime(p.laps[index].time); }
            }
        }, true);
        document.querySelectorAll('#minHoursInput, #minMinutesInput, #minSecondsInput, #maxHoursInput, #maxMinutesInput, #maxSecondsInput, #secondaryTitleInput, #notesInput, #globalJobTitleInput').forEach(input => { input.addEventListener('change', saveState); });
        startBtn.addEventListener('click', onStartClick); pauseBtn.addEventListener('click', onPauseClick); lapBtn.addEventListener('click', recordLap);
        resetBtn.addEventListener('click', () => { const p = getActiveProcess(); if(p) showConfirmationModal(`Reset "${p.name}"?`, resetTimer); });
        printBtn.addEventListener('click', printData); newProcessBtn.addEventListener('click', showNewProcessModal);
        cancelProcessBtn.addEventListener('click', hideNewProcessModal);
        createProcessBtn.addEventListener('click', () => { const name = newProcessNameInput.value.trim() || 'Process'; createNewProcess(name); hideNewProcessModal(); });
    </script>
</body>
</html>